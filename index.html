<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Adyen Installments Configuration Generator</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
          integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
            integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
            crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
            integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
            crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
            integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
            crossorigin="anonymous"></script>
</head>
<body>
<div class="mx-auto container border m-2 p-2 bg-light sticky-top shadow-sm">
    <div class="mt-2 mb-2">
        <div class="input-group">
            <div class="input-group-prepend">
                <button type="button" class="btn btn-primary" id="outputPrepend" onclick="copyText()">Copy</button>
            </div>
            <input type="text" class="form-control" id="outputString" aria-describedby="outputPrepend"
                   oninput="handleOutputChange(this.value)">
            <div class="input-group-append">
                <span class="input-group-text" id="charsCount">0/1000</span>
            </div>
            <div id="outputFeedback" class="invalid-feedback"></div>
        </div>
    </div>
    <div class="alert alert-info alert-dismissible fade show" role="alert">
        <strong>Hey there!</strong> Soon as you finish your changes, press the <strong>Copy</strong> button above to copy the text and paste it into Oracle Commerce Cloud
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
</div>
<div role="alert" aria-live="assertive" aria-atomic="true" class="toast" id="toaster" data-autohide="true"
     style="position: absolute; top: 15px; right: 45%; z-index: 999999">
    <div class="toast-body">
        Copied to clipboard!
    </div>
</div>
<div id="rules-wrapper">
    <div id="rules" class="overflow-auto mx-auto container border shadow-sm m-2 p-2">
        <div class="d-flex p-2 bd-highlight justify-content-between">
            <h2>Rules</h2>
            <button type="button" id="addRule" href="#" class="btn btn-primary">Add new rule  <span id="counter" class="badge badge-light">0</span></button>
        </div>
        <div class="d-flex flex-wrap p-2" id="rulesRow"></div>
    </div>
</div>
<script>
    let rulesCount = 0;
    let result = {};
    const creditCards = [
        {id: 1, name: "Amex"},
        // {id: "argencard", name: "Argencard"},
        // {id: "bcmc", name: "Bancontact/Mister Cash"},
        // {id: "bijcard", name: "de Bijenkorf Card"},
        // {id: "cabal", name: "Cabal"},
        // {id: "cartebancaire", name: "Carte Bancaires"},
        // {id: "codensa", name: "Codensa"},
        // {id: "cup", name: "China Union Pay"},
        // {id: "dankort", name: "Dankort"},
        // {id: "diners", name: "Diners Club"},
        // {id: "discover", name: "Discover"},
        {id: 2, name: "ELO"},
        // {id: "forbrugsforeningen", name: "Forbrugsforeningen"},
        {id: 4, name: "HiperCard"},
        // {id: "hipercard", name: "HiperCard"},
        // {id: "jcb", name: "JCB"},
        // {id: "karenmillen", name: "Karen Millen GiftCard"},
        // {id: "laser", name: "Laser"},
        // {id: "maestro", name: "Maestro"},
        // {id: "maestrouk", name: "Maestro UK"},
        {id: 8, name: "Mastercard"},
        // {id: "mcalphabankbonus", name: "Alpha Bank Mastercard Bonus"},
        // {id: "mir", name: "MIR"},
        // {id: "naranja", name: "Naranja"},
        // {id: "oasis", name: "Oasis GiftCard"},
        // {id: "shopping", name: "Tarjeta Shopping"},
        // {id: "solo", name: "Solo"},
        // {id: "troy", name: "Troy"},
        // {id: "uatp", name: "UATP"},
        {id: 16, name: "Visa"},
        // {id: "visaalphabankbonus", name: "Alpha Bank Visa Bonus"},
        // {id: "visadankort", name: "Visa Dankort"},
        // {id: "warehouse", name: "Warehouse GiftCard"},
    ].sort((a, b) => a.name.toLowerCase() > b.name.toLowerCase() ? 1 : -1);
    const outputField = document.getElementById("outputString");
    const outputAppend = document.getElementById('charsCount');
    const sums = {};

    function copyText() {
        $('#toaster').toast('show');

        const input = document.getElementById("outputString");
        input.select();
        document.execCommand('copy')
        document.getSelection().removeAllRanges();
    }

    function toggleOutput(isValid, msg) {
        const errMsg = msg || "Please provide a valid value.";
        document.getElementById('outputFeedback').textContent = errMsg;
        outputField.classList.toggle("is-invalid", !isValid);
        outputField.classList.toggle("is-valid", isValid)
    }

    function validateField(value, id) {
        const isValid = !!value;
        const el = document.getElementById(id);
        el.classList.toggle("is-invalid", !isValid);
        el.classList.toggle("is-valid", isValid)
    }

    function updateHash() {
        const code = JSON.stringify(Object.values(result));
        outputAppend.innerText = `${code.length}/1000`;
        if (code.length > 1000) {
            toggleOutput(false, "Too many rules. Please delete some")
        }
        const el = document.getElementById("outputString");
        el.value = code;
    }

    function handleOnChange(index, id, value) {
        toggleOutput(true);
        result[id][index] = parseInt(value);
        updateHash()
    }

    function handleSelect(id, value) {
        const hasId = id in sums;
        if (!hasId) { sums[id] = [] }

        const parsedValue = parseInt(value)
        const hasValue = sums[id].includes(parsedValue);
        sums[id] = hasValue ? sums[id].filter(v => v !== parsedValue) : [...sums[id], parsedValue];
        const sum = sums[id].reduce((acc, num) => parseInt(acc) + parseInt(num));

        result[id][2] = parseInt(sum);
        updateHash()
    }

    function isAllowedCreditCard(ruleId, value) {
        const index = parseInt(value) & result[ruleId][2];
        return index !== 0
    }

    function duplicateRule(id) {
        result[rulesCount + 1] = [...result[id]];
        sums[rulesCount + 1] = [...sums[id]];
        updateHash();
        addRule()
    }

    function removeRule(id) {
        document.getElementById(`rule${id}`).remove();
        delete result[id];
        setCounter(rulesCount - 1);
        updateHash()
    }

    function setCreditCards() {
        Object.entries(result).forEach(([resultId, val]) => {
            sums[resultId] = [];
            creditCards.forEach(({ id }) => {
                console.log(id, val[2], parseInt(id) & val[2])
                if ((parseInt(id) & val[2]) !== 0) sums[resultId] = [...sums[resultId], parseInt(id)]
            });
            addRule(resultId)
        });
    }

    function handleOutputChange(value) {
        try {
            const json = JSON.parse(value);
            outputAppend.innerText = `${value.length}/1000`;
            setCounter(0);
            result = json.reduce((acc, item, idx) => ({...acc, [idx + 1]: item }),{});
            document.getElementById("rulesRow").innerHTML = "";

            setCreditCards()
            toggleOutput(true)
        } catch (e) {
            toggleOutput(false)
        }
    }

    function setCounter(val) {
        rulesCount = val;
        document.getElementById('counter').innerText = rulesCount;
    }

    function addRule() {
        setCounter(rulesCount + 1);
        const hasRules = rulesCount in result;
        if (!hasRules) {
            result[rulesCount] = [0, 1, 0]
        }
        const el = document.createElement('div');
        el.setAttribute("id", `rule${rulesCount}`);
        el.setAttribute("class", "col-lg-4 col-md-6 col-sm-6 mb-2");
        el.innerHTML = `
            <div class="card shadow-sm" aria-labelledby="headingOne">
                <div class="card-body bg-light">
                    <form>
                        <div class="form-group">
                            <label for="amountRange${rulesCount}">Minimum Amount</label>
                            <input onblur="validateField(this.value, this.id)" min="0" type="number" class="form-control" id="amountRange${rulesCount}" aria-describedby="amountRange" placeholder="Enter Amount" oninput="handleOnChange(0, ${rulesCount}, this.value)" value="${result[rulesCount][0]}">
                            <div class="invalid-feedback"></div>
                        </div>
                        <div class="form-group">
                            <label for="numberOfInstallments${rulesCount}">Number of Installments</label>
                            <input  onblur="validateField(this.value, this.id)"  min="1" type="number" class="form-control" id="numberOfInstallments${rulesCount}" aria-describedby="numberOfInstallments" placeholder="Enter Number of Installments" oninput="handleOnChange(1, ${rulesCount}, this.value)" value="${result[rulesCount][1]}">
                        </div>
                        <div class="form-group">
                            <label for="allowedCreditCards${rulesCount}">Allowed Credit Card Types</label>
                            ${creditCards.map(({ id, name }) => {
                                if (isAllowedCreditCard(rulesCount, id)) {
                                    return `<div id="allowedCreditCards${rulesCount}" class="custom-control custom-switch">
                                        <input checked type="checkbox" class="custom-control-input" value="${id}" onchange="handleSelect(${rulesCount}, this.value)" id="switch-${rulesCount}-${id}">
                                        <label class="custom-control-label" for="switch-${rulesCount}-${id}">${name}</label>
                                    </div>`
                                }

                                return `<div id="allowedCreditCards${rulesCount}"  class="custom-control custom-switch">
                                  <input type="checkbox" class="custom-control-input" value="${id}" onchange="handleSelect(${rulesCount}, this.value)" id="switch-${rulesCount}-${id}">
                                  <label class="custom-control-label" for="switch-${rulesCount}-${id}">${name}</label>
                                </div>`
                            }).join("")}
                        </div>
                        <button type="button" class="btn btn-primary btn-block" id="duplicateRule${rulesCount}" onclick="duplicateRule(${rulesCount})">Duplicate Rule</button>
                        <button type="button" class="btn btn-outline-danger btn-block" id="deleteRule${rulesCount}" onclick="removeRule(${rulesCount})">Delete Rule</button>
                    </form>
                </div>
            </div>
        `;
        document.getElementById("rulesRow").appendChild(el)
    }

    document.getElementById("addRule").addEventListener('click', addRule)
</script>
</body>
</html>
