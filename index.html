<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Adyen Installments Configuration Generator</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
          integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
            integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
            crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
            integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
            crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
            integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
            crossorigin="anonymous"></script>
</head>
<body>
<div class="mx-auto container border m-2 p-2 bg-light fixed-top">
    <div class="mt-2 mb-2">
        <div class="input-group">
            <div class="input-group-prepend">
                <button type="button" class="btn btn-primary" id="outputPrepend" onclick="copyText()">Copy</button>
            </div>
            <input type="text" class="form-control" id="outputString" aria-describedby="outputPrepend"
                   oninput="handleOutputChange(this.value)">
            <div class="invalid-feedback">
                Please provide a valid value.
            </div>
        </div>
        <small id="outputHelp" class="form-text text-muted">Copy this text into the installments field</small>
    </div>
</div>
<div role="alert" aria-live="assertive" aria-atomic="true" class="toast" id="toaster" data-autohide="true"
     style="position: absolute; top: 15px; right: 45%; z-index: 999999">
    <div class="toast-body">
        Copied to clipboard!
    </div>
</div>
<div id="rules-wrapper" style="margin-top: 115px;">
    <div id="rules" class="overflow-auto mx-auto container border m-2 p-2" style="max-height: calc(100vh - 190px)">
        <h2>Rules</h2>
        <div class="row" id="rulesRow"></div>
    </div>
</div>
<div class="mx-auto container border m-2 p-2 fixed-bottom">
    <button type="button" class="btn btn-primary" id="addRule">Add Rule</button>
</div>
<script>
    let rulesCount = 0;
    let result = {};
    const creditCards = [
        { name: "American Express", id: 'amex' },
        { name: "Diners", id: "diners" },
        { name: "Discover", id: "discover" },
        { name: "Laser", id: "laser" },
        { name: "Maestro", id: "maestro" },
        { name: "MasterCard", id: "mc" },
        { name: "Visa", id: 'visa' },
    ]
    const outputField = document.getElementById("outputString");

    function copyText() {
        $('#toaster').toast('show')

        const input = document.getElementById("outputString")
        input.select();
        document.execCommand('copy')
    }

    function toggleOutput(isValid) {
        outputField.classList.toggle("is-invalid", !isValid)
        outputField.classList.toggle("is-valid", isValid)
    }

    function updateHash() {
        const code = btoa(JSON.stringify(result, null, 2))
        document.getElementById("outputString").value = code;
    }

    function handleOnChange(field, id, value) {
        toggleOutput(true)
        if (field === 'numberOfInstallments') document.getElementById(`installmentsVal${id}`).innerText = value
        result[id][field] = value;
        updateHash()
    }

    function duplicateRule(id) {
        result[rulesCount + 1] = { ...result[id] }
        updateHash()
        addRule()
    }

    function removeRule(id) {
        document.getElementById(`rule${id}`).remove();
        delete result[id]
        updateHash()
    }

    function handleOutputChange(value) {
        try {
            const json = JSON.parse(atob(value));
            rulesCount = 0;
            result = json;
            document.getElementById("rulesRow").innerHTML = ""
            Object.keys(result).forEach(addRule)
            toggleOutput(true)
        } catch (e) {
            toggleOutput(false)
        }
    }

    function addRule() {
        rulesCount++;
        const hasRules = rulesCount in result;
        if (!hasRules) {
            result[rulesCount] = {amountRange: "", numberOfInstallments: 1, allowedCreditCards: []}
        }
        const el = document.createElement('div')
        el.setAttribute("id", `rule${rulesCount}`)
        el.setAttribute("class", "col-3 mb-2")
        el.innerHTML = `
            <div class="card" aria-labelledby="headingOne">
                <div class="card-body">
                    <form>
                        <div class="form-group">
                            <label for="amountRange${rulesCount}">Amount Range</label>
                            <input type="number" class="form-control" id="amountRange${rulesCount}" aria-describedby="amountRange" placeholder="Enter Amount" oninput="handleOnChange('amountRange', ${rulesCount}, this.value)" value="${result[rulesCount].amountRange}">
                        </div>
                        <div class="form-group">
                            <label for="numberOfInstallments${rulesCount}">Number of Installments: <span  id="installmentsVal${rulesCount}">${result[rulesCount].numberOfInstallments}</span></label>
                            <input type="range" class="custom-range" min="1" max="72" id="numberOfInstallments${rulesCount}" step="1" onchange="handleOnChange('numberOfInstallments', ${rulesCount}, this.value)" value="${result[rulesCount].numberOfInstallments}">
                        </div>
                        <div class="form-group">
                            <label for="allowedCreditCards${rulesCount}">Allowed Credit Card Types</label>
                            <select multiple class="form-control" id="allowedCreditCards${rulesCount}" onchange="handleOnChange('allowedCreditCards', ${rulesCount}, Array.from(this.selectedOptions).map(option => option.value))">
                                ${creditCards.map(({ id, name }) => {
                                    if (result[rulesCount].allowedCreditCards.includes(id)) return `<option selected value="${id}">${name}</option>`
                                    return `<option value="${id}">${name}</option>`
                                })}
                            </select>
                        </div>
                        <button type="button" class="btn btn-light btn-block" id="duplicateRule${rulesCount}" onclick="duplicateRule(${rulesCount})">Duplicate Rule</button>
                        <button type="button" class="btn btn-outline-danger btn-block" id="deleteRule${rulesCount}" onclick="removeRule(${rulesCount})">Delete Rule</button>
                    </form>
                </div>
            </div>
        `
        document.getElementById("rulesRow").appendChild(el)

    }

    document.getElementById("addRule").addEventListener('click', addRule)
</script>
</body>
</html>
